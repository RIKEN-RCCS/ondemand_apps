script:
  job_name: ood_desktop
  desktop: xfce
  <%- if cluster == "prepost" then -%>
  queue_name: <%= custom_queue %>
  gpus_per_node: <%= gpus_per_node %>
  <%- end -%>
  <%- if email.present? -%>
  email: <%= email %>
  email_on_started: true
  <%- end -%>
  native:
  <%- if cluster == "prepost" then -%>
  <%- if required_memory.present? -%>
  - "--mem"
  - "<%= required_memory %>G"
  <%- end -%>
  - "-n"
  - "<%= num_cores.blank? ? 1 : num_cores.to_i %>"
  <%- elsif cluster == "fugaku" -%>
  - "-L node=1,jobenv=singularity --no-check-directory -x PJM_LLIO_GFSCACHE=/vol0004"
  <%- if group.present? -%>
  - "-g"
  - "<%= group %>"
  <%- end -%>
  <%- end -%>
batch_connect:
  template: "vnc"
  websockify_cmd: '/usr/bin/websockify'
  script_wrapper: |
    cat << "CTRSCRIPT" > <%= staged_root %>/container.sh
    export PATH="$PATH:/opt/TurboVNC/bin"
    export PATH="$PATH:/opt/ParaView/bin"
    export LANG=C
    %s  
    CTRSCRIPT
     
    export LANG=C
    export SINGULARITYENV_XDG_DATA_HOME=${HOME}/.ondemand/xfce_desktop/`arch`
    export SINGULARITYENV_TMPDIR=${SINGULARITYENV_XDG_DATA_HOME}/tmp
    export SINGULARITYENV_XDG_RUNTIME_DIR=${SINGULARITYENV_TMPDIR}
    export SINGULARITY_BINDPATH=/data,/work
    mkdir -p $SINGULARITYENV_TMPDIR
    NV_OPTION=""
    CUDA_VERSION=11.5
    if [ -e /usr/local/cuda-$CUDA_VERSION ]; then
        export SINGULARITY_BINDPATH=$SINGULARITY_BINDPATH,/usr/local/cuda-$CUDA_VERSION:/usr/local/cuda
        NV_OPTION="--nv"
    fi
    for i in `ls -l /opt | grep ^d | awk '{print $9}'`; do
        export SINGULARITY_BINDPATH=$SINGULARITY_BINDPATH,/opt/$i
    done

    IMAGE=/home/apps/singularity/ondemand/xfce_desktop_`arch`.sif
    singularity run ${NV_OPTION} ${IMAGE} <%= staged_root %>/container.sh
    
