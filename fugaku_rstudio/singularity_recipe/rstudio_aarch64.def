Bootstrap: library
#From: rockylinux:latest
From: rockylinux:8.6
  
%post
        dnf -y install hostname gcc gcc-gfortran gcc-c++ perl java vim emacs zsh git cmake numactl libcgroup boost boost-devel
        dnf -y install epel-release dnf-plugins-core wget
        dnf config-manager --set-enabled powertools
        dnf -y install Lmod
        #
        dnf -y install ant tar git R bzip2 libxml2-devel pandoc sudo mlocate soci-sqlite3-devel
        wget https://github.com/rstudio/rstudio/archive/refs/tags/v2022.02.1+461.tar.gz
        tar xfz v2022.02.1+461.tar.gz
        cd rstudio-2022.02.1-461/dependencies/common/
        ./install-dictionaries
        ./install-mathjax
        ./install-yaml-cpp
        ./install-boost
        ./install-packages
        cd ../linux
        grep -v xml-commons-apis ./install-dependencies-yum >  ./install-dependencies-yum-new
        sh ./install-dependencies-yum-new
        cd ../../
        mkdir build; cd build
        CXXFLAGS="-march=native" cmake .. -DRSTUDIO_TARGET=Server -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/lib/rstudio-server
        # If too many cores, it will run out of memory.
        make -j 24; make install
        cd ../../
        rm -rf v2022.02.1+461.tar.gz rstudio-2022.02.1-461
        #
        dnf clean all

